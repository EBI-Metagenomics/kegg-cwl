os: linux

services:
  - docker

language: python
python: 3.6

install:
  - pip install -q cwl-runner cwltest cwltool
  - mkdir $TRAVIS_BUILD_DIR/Tools/Hmmscan/db/

  - wget ftp://ftp.ebi.ac.uk/pub/databases/metagenomics/kegg_db/merged.h3f -O $TRAVIS_BUILD_DIR/Tools/Hmmscan/db//merged.h3f
  - wget ftp://ftp.ebi.ac.uk/pub/databases/metagenomics/kegg_db/merged.h3m -O $TRAVIS_BUILD_DIR/Tools/Hmmscan/db/merged.h3m
  - wget ftp://ftp.ebi.ac.uk/pub/databases/metagenomics/kegg_db/merged.h3i -O $TRAVIS_BUILD_DIR/Tools/Hmmscan/db/merged.h3i
  - wget ftp://ftp.ebi.ac.uk/pub/databases/metagenomics/kegg_db/merged.h3p -O $TRAVIS_BUILD_DIR/Tools/Hmmscan/db/merged.h3p
  - >
    docker build -t hmmscan_kegg $TRAVIS_BUILD_DIR/Tools/Hmmscan/ &
    docker build -t kegg $TRAVIS_BUILD_DIR/Tools/KEGG_pathways/ &
    docker build -t parsing_hmmscan $TRAVIS_BUILD_DIR/Tools/Parsing_hmmscan/ &
    docker build -t sed_docker $TRAVIS_BUILD_DIR/Tools/Sed/ &
    docker build -t kegg_union_by_contigs $TRAVIS_BUILD_DIR/Tools/Union_by_contigs/
    ; wait

script:
  - cwltest --test $TRAVIS_BUILD_DIR/Tests/test_pipeline.yml --timeout 7200 --tool cwltool

deploy:
  provider: script
  script: bash $TRAVIS_BUILD_DIR/docker_push.sh
  on:
    branch: master